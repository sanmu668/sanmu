import{d as _e,r as c,c as oe,u as we,o as ne,Q as Ie,E as y,b as D,e as d,B as k,i as l,h as i,g as p,f as I,A as C,j as R,R as j,I as W,J as le,t as G,L,S as re,M as ke,U as Ce,V as Se,W as be,X as xe,m as Te,Y as De,Z as Me,_ as $e,$ as Ae,x as Ee,a0 as Be,P as Ne,a1 as Ue,O as Ve,a2 as Oe,a3 as Re}from"./index-a7f98987.js";import{a as ce}from"./index-99461ef4.js";import{a as je}from"./axios-3a665b0f.js";import{_ as qe}from"./_plugin-vue_export-helper-c27b6911.js";const ze=ce.BASE_URL,q=je.create({baseURL:ze,timeout:ce.TIMEOUT});q.interceptors.request.use(v=>{const u=localStorage.getItem("token");return u&&v.headers&&(v.headers.Authorization=`Bearer ${u}`),v},v=>Promise.reject(v));q.interceptors.response.use(v=>v,v=>Promise.reject(v));const ie=async({question:v,sessionId:u,file:h})=>{try{const m=new FormData;return m.append("sessionId",u),v&&m.append("question",v),h&&m.append("file",h),(await q.post("/api/chat/message",m,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${localStorage.getItem("token")}`,Accept:"application/json"}})).data}catch(m){throw console.error("发送消息失败:",m),m}},ue=async v=>{try{return(await q.get("/api/chat/history",{params:{sessionId:v.sessionId||void 0},headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json",Accept:"application/json"}})).data}catch(u){throw console.error("获取历史消息失败:",u),u}},He=async()=>(await q.post("/api/chat/new-session",null,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json",accept:"*/*"}})).data,Le={class:"ai-chat-container"},Fe={class:"sidebar-header"},Pe={class:"sidebar-content"},Ke={class:"sidebar-section"},Je={class:"chat-history"},Qe=["onClick"],We={class:"avatar"},Ge={class:"message-content"},Xe={class:"message-bubble"},Ye={key:0,class:"message-time"},Ze={key:0,class:"file-upload-icon"},et={class:"input-area"},tt={class:"input-wrapper"},st={class:"action-buttons"},at={class:"operation-menu-items"},ot={class:"dialog-footer"},nt=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.txt",lt=_e({__name:"AiChat",setup(v){const u={plus:be,fold:xe,document:Te,upload:De,loading:Me,warning:$e,chatRound:Ae,user:Ee,service:Be,more:Ne,edit:Ue,delete:Ve,paperclip:Oe},h=c(""),m=c(!1),f=c([]),z=c(null),M=c(!1),g=c(""),F=c(""),_=c(null),S=c(null),$=c(!1),P=c({x:0,y:0}),A=c(!1),E=c(""),B=c(null);c(!1),c(1),c(1);const w=c([]);c(!1);const K=oe(()=>w.value.find(t=>t.id===S.value)),b=we(),de=()=>{M.value=!M.value},N=()=>{const t=localStorage.getItem("token");if(console.log("Token:",t?"存在":"不存在"),!t)return y.error("请先登录"),b.push("/login"),!1;const e=localStorage.getItem("user");if(console.log("User Info:",e),e)try{const s=JSON.parse(e);return _.value=s.id||s.userId,console.log("从用户信息中获取到的用户ID:",_.value),!0}catch(s){console.error("解析用户信息失败:",s)}try{const n=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),a=decodeURIComponent(atob(n).split("").map(function(T){return"%"+("00"+T.charCodeAt(0).toString(16)).slice(-2)}).join("")),o=JSON.parse(a);return _.value=o.id||o.userId||o.sub,console.log("从Token中解析到的用户ID:",_.value),!0}catch(s){console.error("解析Token失败:",s)}return y.error("获取用户信息失败，请重新登录"),b.push("/login"),!1},J=t=>t?t.replace(/#{1,}/g,"").replace(/\d+\./g,`
$&`).replace(/[一二三四五六七八九十]、/g,`
$&`).replace(/\s*-\s*/g,`
- `).trim():"",U=async()=>{var t;if(N())try{const e=await He();e&&(g.value=e.sessionId,F.value="",f.value=[{...e,content:J(e.answer||"你好！我是AI助手，很高兴为您服务。请问有什么我可以帮您的吗？"),type:"ai",time:x(e.timestamp)}])}catch(e){((t=e.response)==null?void 0:t.status)===401?(y.error("登录已过期，请重新登录"),b.push("/login")):(y.error("创建新会话失败，请稍后重试"),console.error("Error creating new session:",e))}},pe=async t=>{var e;if(N())try{S.value=t.id,g.value=t.sessionId,F.value=t.title;const n=(await ue({userId:_.value,sessionId:t.sessionId})).sort((o,T)=>new Date(o.timestamp).getTime()-new Date(T.timestamp).getTime()),a=[];n.forEach(o=>{o.question&&a.push({...o,content:o.question,type:"user",time:x(o.timestamp)}),o.answer&&a.push({...o,content:o.answer,type:"ai",time:x(o.timestamp)})}),f.value=a,await O()}catch(s){((e=s.response)==null?void 0:e.status)===401?(y.error("登录已过期，请重新登录"),b.push("/login")):(y.error("加载历史对话失败"),console.error("Error loading chat history:",s))}},V=()=>{const t=new Date,e=t.getHours().toString().padStart(2,"0"),s=t.getMinutes().toString().padStart(2,"0");return`${e}:${s}`},x=t=>{if(!t)return"";try{const e=new Date(t);if(isNaN(e.getTime()))return"";const s=e.getHours().toString().padStart(2,"0"),n=e.getMinutes().toString().padStart(2,"0");return`${s}:${n}`}catch{return""}},O=async()=>{await Re(),z.value&&(z.value.scrollTop=z.value.scrollHeight)},ve=async()=>{var t;try{const s=(await ue({userId:_.value,sessionId:""})).sort((a,o)=>new Date(o.timestamp).getTime()-new Date(a.timestamp).getTime()),n=new Map;s.forEach(a=>{var o;n.has(a.sessionId)||n.set(a.sessionId,{id:Date.now().toString()+Math.random().toString(36).substr(2,9),sessionId:a.sessionId,title:((o=a.question)==null?void 0:o.slice(0,20))+"..."||`对话 ${x(a.timestamp)}`,lastMessage:a.answer||a.question||"",timestamp:x(a.timestamp)})}),w.value=Array.from(n.values())}catch(e){console.error("加载历史对话失败:",e),((t=e.response)==null?void 0:t.status)===401?(y.error("登录已过期，请重新登录"),b.push("/login")):y.error("加载历史对话失败")}},X=()=>{if(!g.value||f.value.length===0)return;const t=f.value.filter(o=>o.type==="user").pop(),e=f.value.filter(o=>o.type==="ai").pop(),s=F.value||(t?t.content.slice(0,20)+"...":`对话 ${V()}`),n={id:Date.now().toString(),sessionId:g.value,title:s,lastMessage:(e==null?void 0:e.content)||(t==null?void 0:t.content)||"",timestamp:V()},a=w.value.findIndex(o=>o.sessionId===g.value);a!==-1?w.value[a]=n:w.value.unshift(n)},Y=async()=>{var n;if(!h.value.trim()||!N())return;g.value||await U();const t=new Date().toISOString(),e={id:Date.now(),userId:_.value,sessionId:g.value,content:h.value,question:h.value,type:"user",time:V(),timestamp:t};f.value.push(e);const s=h.value;h.value="",await O(),m.value=!0;try{const a=await ie({question:s,sessionId:g.value});if(a){const o={...a,content:J(a.answer||""),type:"ai",time:x(a.timestamp)};f.value.push(o),X()}}catch(a){console.error("Error:",a),ae(a),((n=a.response)==null?void 0:n.status)===401&&b.push("/login")}finally{m.value=!1,O()}},me=(t,e)=>{t.stopPropagation(),$.value=!0;const s=t.target.getBoundingClientRect();P.value={x:s.right-100,y:s.top},S.value=e.id,B.value="chat"},fe=async t=>{E.value=t.title,A.value=!0,B.value="chat",$.value=!1},Z=()=>{if(B.value==="chat"&&K.value){const t=w.value.findIndex(e=>e.id===S.value);t!==-1&&(w.value[t].title=E.value)}A.value=!1,E.value="",B.value=null},ge=async t=>{const e=w.value.findIndex(s=>s.id===t.id);e!==-1&&(w.value.splice(e,1),S.value===t.id&&(S.value=null,await U())),$.value=!1},ee=t=>{const e=t.target;!e.closest(".operation-menu")&&!e.closest(".operation-icon")&&($.value=!1)};ne(()=>{document.addEventListener("click",ee)}),Ie(()=>{document.removeEventListener("click",ee)}),ne(async()=>{if(console.log("组件挂载，开始检查登录状态..."),console.log("LocalStorage内容:",{token:localStorage.getItem("token"),user:localStorage.getItem("user")}),N()){console.log("用户已登录，userId:",_.value);try{await ve(),console.log("历史对话加载成功"),S.value||await U()}catch(t){console.error("初始化失败:",t),y.error("加载历史对话失败，请刷新页面重试")}}else console.log("用户未登录或登录状态无效")});const Q=oe(()=>B.value==="chat"&&K.value?K.value:null),te=t=>t.size>10485760?(y.error("文件大小不能超过10MB"),!1):!0,se=t=>{te(t.raw)&&he(t.raw)},he=async t=>{var n;if(!N())return;g.value||await U();const e=new Date().toISOString(),s={id:Date.now(),userId:_.value,sessionId:g.value,content:`上传文件：${t.name}`,question:`上传文件：${t.name}`,type:"user",time:V(),timestamp:e};f.value.push(s),await O(),m.value=!0;try{const a=await ie({sessionId:g.value,file:t});if(a){const o={...a,content:J(a.answer||""),type:"ai",time:x(a.timestamp)};f.value.push(o),X()}}catch(a){console.error("Error:",a),ae(a),((n=a.response)==null?void 0:n.status)===401&&b.push("/login")}finally{m.value=!1,O()}},ae=t=>{var a;const e=new Date().toISOString();let s="抱歉，服务出现了一些问题，请稍后再试。";if(t.code==="ECONNABORTED")s=t.message||"请求响应时间过长，请稍后重试。";else if(t.response)switch(t.response.status){case 401:s="会话已过期，请刷新页面重新开始对话。";break;case 429:s="请求过于频繁，请稍后再试。";break;case 500:s="服务器内部错误，请稍后重试。";break;case 502:s="服务暂时不可用，请稍后重试。";break;case 503:s="服务器正在维护，请稍后重试。";break;case 504:s="服务器响应超时，请稍后重试。";break}else t.request&&(s="无法连接到服务器，请检查网络连接。");const n={id:Date.now(),userId:_.value,sessionId:g.value,content:s,type:"ai",time:V(),timestamp:e};f.value.push(n),y.error({message:s,duration:5e3,showClose:!0}),((a=t.response)==null?void 0:a.status)===401&&setTimeout(()=>{b.push("/login")},2e3)};return(t,e)=>{const s=D("el-icon"),n=D("el-button"),a=D("el-avatar"),o=D("el-upload"),T=D("el-input"),ye=D("el-dialog");return d(),k("div",Le,[l("div",{class:j(["sidebar",{collapsed:M.value}])},[l("div",Fe,[i(n,{type:"primary",class:"new-chat-btn",onClick:U},{default:p(()=>[i(s,null,{default:p(()=>[(d(),I(C(u.plus)))]),_:1}),e[6]||(e[6]=R(" 新对话 "))]),_:1}),i(s,{class:j(["collapse-icon",{collapsed:M.value}]),onClick:de},{default:p(()=>[(d(),I(C(u.fold)))]),_:1},8,["class"])]),l("div",Pe,[l("div",Ke,[e[7]||(e[7]=l("h3",null,"历史对话",-1)),l("div",Je,[(d(!0),k(W,null,le(w.value,r=>(d(),k("div",{key:r.id,class:j(["chat-item",{selected:S.value===r.id}]),onClick:H=>pe(r)},[i(s,null,{default:p(()=>[(d(),I(C(u.chatRound)))]),_:1}),l("span",null,G(r.title),1),i(s,{class:"operation-icon",onClick:H=>me(H,r)},{default:p(()=>[(d(),I(C(u.more)))]),_:2},1032,["onClick"])],10,Qe))),128))])])])],2),l("div",{class:j(["chat-window",{"sidebar-collapsed":M.value}])},[e[10]||(e[10]=l("div",{class:"chat-header"},[l("h2",null,"AI 智能助手")],-1)),l("div",{class:"messages",ref_key:"messagesContainer",ref:z},[(d(!0),k(W,null,le(f.value,(r,H)=>(d(),k("div",{key:H,class:j(["message-wrapper",r.type])},[l("div",We,[i(a,{size:36},{default:p(()=>[i(s,null,{default:p(()=>[(d(),I(C(r.type==="user"?u.user:u.service)))]),_:2},1024)]),_:2},1024)]),l("div",Ge,[l("div",Xe,G(r.content),1),r.time?(d(),k("div",Ye,G(r.time),1)):L("",!0)]),r.type==="user"?(d(),k("div",Ze,[i(o,{class:"upload-link",action:null,"auto-upload":!1,"show-file-list":!1,"on-change":se},{default:p(()=>[i(s,null,{default:p(()=>[(d(),I(C(u.paperclip)))]),_:1})]),_:1})])):L("",!0)],2))),128))],512),l("div",et,[l("div",tt,[i(T,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=r=>h.value=r),type:"textarea",rows:3,maxlength:1e3,"show-word-limit":"",resize:"none",placeholder:"请输入您的问题...",onKeyup:re(ke(Y,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeyup"]),l("div",st,[i(o,{class:"upload-btn",action:null,"auto-upload":!1,"show-file-list":!1,"on-change":se,"before-upload":te,multiple:"",accept:nt},{default:p(()=>[i(n,{type:"primary",plain:""},{default:p(()=>[i(s,null,{default:p(()=>[(d(),I(C(u.upload)))]),_:1}),e[8]||(e[8]=R(" 上传文件 "))]),_:1})]),_:1}),i(n,{type:"primary",loading:m.value,disabled:!h.value.trim(),onClick:Y},{default:p(()=>e[9]||(e[9]=[R(" 发送 ")])),_:1},8,["loading","disabled"])])])])],2),(d(),I(Se,{to:"body"},[$.value?(d(),k("div",{key:0,class:"operation-menu",style:Ce({left:`${P.value.x}px`,top:`${P.value.y}px`})},[l("div",at,[Q.value?(d(),k(W,{key:0},[l("div",{class:"operation-item",onClick:e[1]||(e[1]=r=>fe(Q.value))},[i(s,null,{default:p(()=>[(d(),I(C(u.edit)))]),_:1}),e[11]||(e[11]=l("span",null,"重命名",-1))]),l("div",{class:"operation-item delete",onClick:e[2]||(e[2]=r=>ge(Q.value))},[i(s,null,{default:p(()=>[(d(),I(C(u.delete)))]),_:1}),e[12]||(e[12]=l("span",null,"删除",-1))])],64)):L("",!0)])],4)):L("",!0)])),i(ye,{modelValue:A.value,"onUpdate:modelValue":e[5]||(e[5]=r=>A.value=r),title:"重命名",width:"300px","show-close":!0,"close-on-click-modal":!1,"destroy-on-close":""},{footer:p(()=>[l("span",ot,[i(n,{onClick:e[4]||(e[4]=r=>A.value=!1)},{default:p(()=>e[13]||(e[13]=[R("取消")])),_:1}),i(n,{type:"primary",onClick:Z},{default:p(()=>e[14]||(e[14]=[R("确定")])),_:1})])]),default:p(()=>[i(T,{modelValue:E.value,"onUpdate:modelValue":e[3]||(e[3]=r=>E.value=r),placeholder:"请输入新名称",onKeyup:re(Z,["enter"])},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}});const dt=qe(lt,[["__scopeId","data-v-718139df"]]);export{dt as default};
